<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ å°ç£å˜‰ç¾©å°å—æ—…éŠè·¯ç·š</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .route-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .route-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .route-btn.active {
            transform: scale(1.05);
        }

        .route2-btn {
            background: #10b981;
            color: white;
        }

        .day1-btn {
            background: #f59e0b;
            color: white;
        }

        .map-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            min-height: 400px;
        }

        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #searchInput {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        #searchInput:focus {
            border-color: #667eea;
        }

        .search-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background: #5568d3;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .distance-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .distance-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .distance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .distance-table th,
        .distance-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .distance-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        .distance-total {
            font-weight: bold;
            background: #f0f9ff;
            color: #3b82f6;
        }

        .custom-location {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .remove-btn {
            padding: 4px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            #map {
                height: 400px;
            }

            .route-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .search-box {
                flex-direction: column;
            }

            .distance-table {
                font-size: 14px;
            }

            .distance-table th,
            .distance-table td {
                padding: 8px;
            }
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .info-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .location-icon {
            font-size: 40px;
            margin-right: 10px;
        }

        .location-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .location-desc {
            color: #666;
            font-size: 14px;
            margin: 8px 0;
        }

        .location-time {
            color: #3b82f6;
            font-weight: bold;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            padding: 50px;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        .nearby-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .nearby-container h2 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nearby-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .nearby-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .nearby-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
            background: white;
        }

        .nearby-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .nearby-card-icon {
            font-size: 24px;
        }

        .nearby-card-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .nearby-card-type {
            display: inline-block;
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .nearby-card-distance {
            color: #10b981;
            font-size: 13px;
            font-weight: bold;
        }

        .nearby-card-add {
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 13px;
            width: 100%;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nearby-card-add:hover {
            background: #5568d3;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #059669;
        }

        .loading-nearby {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .map-legend {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            margin-top: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .map-legend {
                gap: 10px;
                font-size: 12px;
            }
        }

        .export-container {
            text-align: center;
            margin: 30px 0;
        }

        .export-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .export-btn:active {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .export-btn {
                padding: 14px 30px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ å°ç£å˜‰ç¾©å°å—æ—…éŠè·¯ç·š</h1>

        <div class="route-buttons">
            <button class="route-btn route2-btn active" onclick="switchRoute('route2')">
                ğŸŒ¿ è·¯ç·šäºŒï¼šå˜‰ç¾©æ–‡åŒ–ä¹‹æ—…
            </button>
            <button class="route-btn day1-btn" onclick="switchRoute('day1')">
                ğŸœ ç¬¬ä¸€å¤©ï¼šå°å—ç¾é£Ÿä¹‹æ—…
            </button>
        </div>

        <div id="status" class="loading">è¼‰å…¥ä¸­...</div>

        <div class="nearby-container" id="nearbyContainer" style="display: none;">
            <h2>
                âœ¨ é™„è¿‘æ¨è–¦æ™¯é»
                <button class="refresh-btn" onclick="loadNearbyAttractions()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                æ ¹æ“šæ‚¨çš„è·¯ç·šæ¨è–¦é™„è¿‘æ™¯é»ï¼Œåœ°åœ–ä¸Šçš„<span style="color: #3b82f6; font-weight: bold;">è—è‰²æ¨™è¨˜</span>å³ç‚ºæ¨è–¦æ™¯é»ï¼Œé»æ“Šå³å¯åŠ å…¥è¡Œç¨‹
            </p>
            <div id="nearbyGrid" class="nearby-grid">
                <div class="loading-nearby">è¼‰å…¥é™„è¿‘æ™¯é»ä¸­...</div>
            </div>
        </div>

        <div class="search-container" id="searchContainer" style="display: none;">
            <h2 style="margin-bottom: 15px;">ğŸ” æœå°‹ä¸¦æ–°å¢æ™¯é»</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¼¸å…¥æ™¯é»åç¨±æˆ–åœ°å€ï¼ˆä¾‹å¦‚ï¼šé˜¿é‡Œå±±ã€å°å—å­”å»Ÿï¼‰">
                <button class="search-btn" onclick="searchLocation()">æœå°‹</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="map-container" id="mapContainer" style="display: none;">
            <h2 style="margin-bottom: 15px;">ğŸ“ äº’å‹•å¼åœ°åœ–</h2>
            <div id="map"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #10b981;"></div>
                    <span>è¡Œç¨‹æ™¯é»</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f59e0b;"></div>
                    <span>è‡ªè¨‚æ™¯é»</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #3b82f6;"></div>
                    <span>ğŸ’¡ æ¨è–¦æ™¯é»ï¼ˆé»æ“ŠåŠ å…¥ï¼‰</span>
                </div>
            </div>
        </div>

        <div class="distance-info" id="distanceInfo" style="display: none;">
            <h3>ğŸš— è·¯ç¨‹è³‡è¨Š</h3>
            <table class="distance-table">
                <thead>
                    <tr>
                        <th>èµ·é»</th>
                        <th>çµ‚é»</th>
                        <th>è·é›¢</th>
                        <th>é ä¼°æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="distanceTableBody"></tbody>
            </table>
        </div>

        <div id="locationsList" class="info-cards"></div>

        <div class="export-container" id="exportContainer" style="display: none;">
            <button class="export-btn" onclick="exportToWord()">
                ğŸ“„ ä¸‹è¼‰è¡Œç¨‹è¦åŠƒå ±å‘Š (Word)
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Control Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    <!-- HTML to Word export -->
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>

    <script>
        console.log('=== Script Started ===');

        // Check if external libraries are loaded
        window.addEventListener('load', function() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            console.log('Checking external libraries...');
            console.log('Device type:', isMobile ? 'Mobile' : 'Desktop');
            console.log('User Agent:', navigator.userAgent);
            console.log('Leaflet loaded:', typeof L !== 'undefined');
            console.log('FileSaver loaded:', typeof saveAs !== 'undefined', '(only required for desktop)');
            console.log('html-docx-js loaded:', typeof htmlDocx !== 'undefined');

            if (typeof htmlDocx === 'undefined') {
                console.warn('âš ï¸ html-docx-js not loaded! Word export will not work.');
            }
            if (!isMobile && typeof saveAs === 'undefined') {
                console.warn('âš ï¸ FileSaver not loaded! Word export may not work on desktop.');
            }
        });

        // Route data
        const ROUTES = {
            route2: {
                name: 'è·¯ç·šäºŒï¼šå˜‰ç¾©æ–‡åŒ–ä¹‹æ—…',
                color: '#10b981',
                locations: [
                    { name: 'æ•…å®®å—é™¢', desc: 'åœ‹ç«‹æ•…å®®åšç‰©é™¢å—éƒ¨é™¢å€', lat: 23.4694, lng: 120.3394, icon: 'ğŸ›ï¸', time: '09:00-11:00' },
                    { name: 'å¸ƒè¢‹æ¼æ¸¯', desc: 'æ–°é®®æµ·ç”¢ã€è§€å…‰æ¼æ¸¯', lat: 23.3778, lng: 120.1647, icon: 'âš“', time: '11:30-12:30' },
                    { name: 'è‹±ç¾©å¤§åˆ©ç”Ÿéºµ', desc: 'å¸ƒè¢‹åœ¨åœ°ç¾é£Ÿ', lat: 23.3765, lng: 120.1655, icon: 'ğŸ', time: '12:30-13:30' },
                    { name: 'é«˜è·Ÿé‹æ•™å ‚', desc: 'IGæ‰“å¡ç†±é»', lat: 23.3625, lng: 120.1394, icon: 'ğŸ‘ ', time: '14:00-15:00' },
                    { name: 'æ–°æ¸¯é¦™è—æ–‡åŒ–åœ’å€', desc: 'é¦™è—æ–‡åŒ–é«”é©—', lat: 23.5547, lng: 120.3478, icon: 'ğŸ•¯ï¸', time: '15:30-16:30' },
                    { name: 'æ–°æ¸¯è€è¡—', desc: 'å‚³çµ±è€è¡—å°åƒ', lat: 23.5569, lng: 120.3456, icon: 'ğŸ®', time: '17:00-18:30' }
                ]
            },
            day1: {
                name: 'ç¬¬ä¸€å¤©ï¼šå°å—ç¾é£Ÿä¹‹æ—…',
                color: '#f59e0b',
                locations: [
                    { name: 'å—é¯¤é¯“ä»£å¤©å®®', desc: 'å°ç£ç‹çˆºç¸½å»Ÿ', lat: 23.2861, lng: 120.0758, icon: 'â›©ï¸', time: '09:00-11:00' },
                    { name: 'é˜¿æ¨‚æ´»æµ·é®®', desc: 'æ–°é®®æµ·ç”¢æ–™ç†', lat: 23.1408, lng: 120.1472, icon: 'ğŸ¦', time: '12:00-13:30' },
                    { name: 'é£¯åº— Check-in', desc: 'ä¼‘æ¯æ”¾é¬†æ™‚å…‰', lat: 22.9908, lng: 120.2133, icon: 'ğŸ¨', time: '14:00-17:00' },
                    { name: 'åœ‹è¯è¡—å¤œå¸‚', desc: 'å°å—ç¾é£Ÿå¤©å ‚', lat: 22.9974, lng: 120.1973, icon: 'ğŸŒƒ', time: '18:00-21:00' }
                ]
            }
        };

        let currentRoute = 'route2';
        let map = null;
        let markers = [];
        let polyline = null;
        let customLocations = [];
        let nearbyAttractions = [];
        let nearbyMarkers = [];
        let loadNearbyTimeout = null;

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Estimate driving time (assuming average speed 50 km/h)
        function estimateTime(distance) {
            const hours = distance / 50;
            const minutes = Math.round(hours * 60);
            if (minutes < 60) {
                return minutes + ' åˆ†é˜';
            } else {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return h + ' å°æ™‚ ' + (m > 0 ? m + ' åˆ†é˜' : '');
            }
        }

        // Update distance information
        function updateDistanceInfo(route) {
            const locations = [...route.locations, ...customLocations];
            if (locations.length < 2) {
                document.getElementById('distanceInfo').style.display = 'none';
                return;
            }

            let html = '';
            let totalDistance = 0;
            let totalMinutes = 0;

            for (let i = 0; i < locations.length - 1; i++) {
                const start = locations[i];
                const end = locations[i + 1];
                const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
                const minutes = Math.round(distance / 50 * 60);

                totalDistance += distance;
                totalMinutes += minutes;

                html += `
                    <tr>
                        <td>${start.icon || 'ğŸ“'} ${start.name}</td>
                        <td>${end.icon || 'ğŸ“'} ${end.name}</td>
                        <td>${distance.toFixed(1)} å…¬é‡Œ</td>
                        <td>${estimateTime(distance)}</td>
                    </tr>
                `;
            }

            html += `
                <tr class="distance-total">
                    <td colspan="2">ç¸½è¨ˆ</td>
                    <td>${totalDistance.toFixed(1)} å…¬é‡Œ</td>
                    <td>${estimateTime(totalDistance)}</td>
                </tr>
            `;

            document.getElementById('distanceTableBody').innerHTML = html;
            document.getElementById('distanceInfo').style.display = 'block';
        }

        // Search location using Nominatim
        async function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div style="padding: 12px;">æœå°‹ä¸­...</div>';
            resultsDiv.classList.add('active');

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' å°ç£')}&limit=5`
                );
                const results = await response.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 12px; color: #999;">æ‰¾ä¸åˆ°çµæœ</div>';
                    return;
                }

                let html = '';
                results.forEach((result, index) => {
                    html += `
                        <div class="search-result-item" onclick="addCustomLocation(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
                            <strong>ğŸ“ ${result.display_name.split(',')[0]}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ${result.display_name}
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div style="padding: 12px; color: red;">æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }

        // Add custom location to route
        function addCustomLocation(lat, lng, name) {
            const shortName = name.split(',')[0];
            const newLocation = {
                name: shortName,
                desc: name,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                icon: 'â­',
                time: 'è‡ªè¨‚',
                custom: true
            };

            customLocations.push(newLocation);

            // Hide search results
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchInput').value = '';

            // Update map and info
            const route = ROUTES[currentRoute];
            showRoute(route);

            console.log('Added custom location:', newLocation);
        }

        // Remove custom location
        function removeCustomLocation(index) {
            customLocations.splice(index, 1);
            const route = ROUTES[currentRoute];
            showRoute(route);
        }

        // Get icon for attraction type
        function getAttractionIcon(type) {
            const iconMap = {
                'tourism': 'ğŸ›ï¸',
                'attraction': 'â­',
                'museum': 'ğŸ›ï¸',
                'viewpoint': 'ğŸŒ…',
                'artwork': 'ğŸ¨',
                'gallery': 'ğŸ–¼ï¸',
                'theme_park': 'ğŸ¢',
                'zoo': 'ğŸ¦',
                'aquarium': 'ğŸ ',
                'picnic_site': 'ğŸ§º',
                'park': 'ğŸŒ³',
                'garden': 'ğŸŒ¸',
                'place_of_worship': 'â›©ï¸',
                'temple': 'ğŸ›•',
                'shrine': 'â›©ï¸',
                'church': 'â›ª',
                'castle': 'ğŸ°',
                'monument': 'ğŸ—¿',
                'memorial': 'ğŸ›ï¸',
                'beach': 'ğŸ–ï¸',
                'lighthouse': 'ğŸ—¼',
                'information': 'â„¹ï¸',
                'hotel': 'ğŸ¨',
                'restaurant': 'ğŸ½ï¸',
                'cafe': 'â˜•',
                'fast_food': 'ğŸ”',
                'bar': 'ğŸº',
                'nightclub': 'ğŸµ',
                'shop': 'ğŸª',
                'mall': 'ğŸ›ï¸',
                'market': 'ğŸª',
                'historic': 'ğŸ›ï¸',
                'ruins': 'ğŸ›ï¸',
                'archaeological_site': 'â›ï¸'
            };
            return iconMap[type] || 'ğŸ“';
        }

        // Get Chinese name for attraction type
        function getAttractionTypeName(type) {
            const typeMap = {
                'tourism': 'æ—…éŠæ™¯é»',
                'attraction': 'æ™¯é»',
                'museum': 'åšç‰©é¤¨',
                'viewpoint': 'è§€æ™¯é»',
                'artwork': 'è—è¡“ä½œå“',
                'gallery': 'è—å»Š',
                'theme_park': 'ä¸»é¡Œæ¨‚åœ’',
                'zoo': 'å‹•ç‰©åœ’',
                'aquarium': 'æ°´æ—é¤¨',
                'picnic_site': 'é‡é¤å€',
                'park': 'å…¬åœ’',
                'garden': 'èŠ±åœ’',
                'place_of_worship': 'å®—æ•™å ´æ‰€',
                'temple': 'å¯ºå»Ÿ',
                'shrine': 'ç¥ç¤¾',
                'church': 'æ•™å ‚',
                'castle': 'åŸå ¡',
                'monument': 'ç´€å¿µç¢‘',
                'memorial': 'ç´€å¿µé¤¨',
                'beach': 'æµ·ç˜',
                'lighthouse': 'ç‡ˆå¡”',
                'information': 'éŠå®¢ä¸­å¿ƒ',
                'hotel': 'é£¯åº—',
                'restaurant': 'é¤å»³',
                'cafe': 'å’–å•¡å»³',
                'fast_food': 'é€Ÿé£Ÿ',
                'bar': 'é…’å§',
                'nightclub': 'å¤œåº—',
                'shop': 'å•†åº—',
                'mall': 'å•†å ´',
                'market': 'å¸‚å ´',
                'historic': 'æ­·å²å¤è¹Ÿ',
                'ruins': 'éºè·¡',
                'archaeological_site': 'è€ƒå¤éºå€'
            };
            return typeMap[type] || 'æ™¯é»';
        }

        // All Taiwan attractions database
        const ALL_ATTRACTIONS = [
            // Chiayi area
            { name: 'æ±çŸ³æ¼äººç¢¼é ­', lat: 23.4603, lng: 120.1492, icon: 'âš“', typeName: 'è§€å…‰æ¼æ¸¯', desc: 'å¤•é™½ç¾æ™¯èˆ‡æµ·é®®' },
            { name: 'æœ´å­é…å¤©å®®', lat: 23.4647, lng: 120.2475, icon: 'â›©ï¸', typeName: 'å»Ÿå®‡', desc: 'å˜‰ç¾©çŸ¥ååª½ç¥–å»Ÿ' },
            { name: 'è’œé ­ç³–å» ', lat: 23.4836, lng: 120.3119, icon: 'ğŸ­', typeName: 'æ–‡åŒ–åœ’å€', desc: 'æ­·å²ç³–å» èˆ‡äº”åˆ†è»Š' },
            { name: 'æ¿é™¶çª¯äº¤è¶¾å‰ªé»å·¥è—åœ’å€', lat: 23.5442, lng: 120.3647, icon: 'ğŸ¨', typeName: 'å·¥è—åœ’å€', desc: 'å‚³çµ±å·¥è—é«”é©—' },
            { name: 'åŒ—æ¸¯æœå¤©å®®', lat: 23.5719, lng: 120.3006, icon: 'â›©ï¸', typeName: 'å»Ÿå®‡', desc: 'å°ç£åª½ç¥–ä¿¡ä»°ä¸­å¿ƒ' },
            { name: 'æºªå£è€è¡—', lat: 23.6039, lng: 120.3933, icon: 'ğŸ®', typeName: 'è€è¡—', desc: 'å‚³çµ±è€è¡—é¢¨æƒ…' },
            { name: 'é˜¿é‡Œå±±æ£®æ—éŠæ¨‚å€', lat: 23.5081, lng: 120.8128, icon: 'ğŸŒ²', typeName: 'æ£®æ—éŠæ¨‚å€', desc: 'æ—¥å‡ºé›²æµ·èˆ‡ç¥æœ¨' },
            { name: 'æ¢…å±±å¤ªå¹³é›²æ¢¯', lat: 23.5633, lng: 120.5986, icon: 'ğŸŒ‰', typeName: 'åŠæ©‹æ™¯é»', desc: 'é«˜ç©ºæ™¯è§€åŠæ©‹' },
            { name: 'å¥®èµ·æ¹–è€è¡—', lat: 23.5044, lng: 120.6972, icon: 'ğŸš‚', typeName: 'è€è¡—', desc: 'éµé“ä¾¿ç•¶èˆ‡è€è¡—' },
            { name: 'æªœæ„æ£®æ´»æ‘', lat: 23.4800, lng: 120.4514, icon: 'ğŸ˜ï¸', typeName: 'æ–‡å‰µåœ’å€', desc: 'æ—¥å¼å»ºç¯‰ç¾¤' },
            { name: 'å˜‰ç¾©æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€', lat: 23.4767, lng: 120.4422, icon: 'ğŸ¨', typeName: 'æ–‡å‰µåœ’å€', desc: 'è—æ–‡å±•æ¼”ç©ºé–“' },

            // Tainan area
            { name: 'äº•ä»”è…³ç“¦ç›¤é¹½ç”°', lat: 23.1808, lng: 120.0769, icon: 'ğŸŒ…', typeName: 'é¹½ç”°æ™¯é»', desc: 'å°ç£æœ€å¤è€é¹½ç”°' },
            { name: 'åŒ—é–€æ°´æ™¶æ•™å ‚', lat: 23.2672, lng: 120.1231, icon: 'â›ª', typeName: 'åœ°æ¨™å»ºç¯‰', desc: 'IGç†±é–€æ‰“å¡é»' },
            { name: 'ä¸ƒè‚¡é¹½å±±', lat: 23.1408, lng: 120.1086, icon: 'â›°ï¸', typeName: 'è§€å…‰é¹½å±±', desc: 'å£¯è§€çš„ç™½è‰²é¹½å±±' },
            { name: 'å®‰å¹³å¤å ¡', lat: 22.9998, lng: 120.1606, icon: 'ğŸ°', typeName: 'æ­·å²å¤è¹Ÿ', desc: 'å°ç£æœ€å¤è€åŸå ¡' },
            { name: 'èµ¤å´æ¨“', lat: 22.9973, lng: 120.2025, icon: 'ğŸ›ï¸', typeName: 'æ­·å²å¤è¹Ÿ', desc: 'å°å—ä»£è¡¨æ€§å¤è¹Ÿ' },
            { name: 'ç¥è¾²è¡—', lat: 22.9978, lng: 120.1947, icon: 'ğŸ®', typeName: 'æ–‡å‰µè€è¡—', desc: 'æ–‡é’å¿…è¨ªè€è¡—' },
            { name: 'è—æ™’åœ–æ–‡å‰µåœ’å€', lat: 22.9908, lng: 120.2050, icon: 'ğŸ¨', typeName: 'æ–‡å‰µåœ’å€', desc: 'å‰µæ„è—è¡“ç©ºé–“' },
            { name: 'æ—ç™¾è²¨', lat: 22.9917, lng: 120.2025, icon: 'ğŸ¬', typeName: 'æ–‡å‰µç™¾è²¨', desc: 'å°å—éŠ€åº§æ‘©å¤©æ¨“' },
            { name: 'å®‰å¹³æ¨¹å±‹', lat: 22.9972, lng: 120.1617, icon: 'ğŸŒ³', typeName: 'æ­·å²éºå€', desc: 'æ¦•æ¨¹èˆ‡å€‰åº«å…±ç”Ÿ' },
            { name: 'å®‰å¹³è€è¡—', lat: 23.0003, lng: 120.1614, icon: 'ğŸ®', typeName: 'è€è¡—', desc: 'å¤æ—©å‘³å°åƒ' },
            { name: 'å››è‰ç¶ è‰²éš§é“', lat: 23.0200, lng: 120.1361, icon: 'ğŸš£', typeName: 'ç”Ÿæ…‹æ™¯é»', desc: 'å°ç£è¢–çç‰ˆäºé¦¬éœæ²³' },
            { name: 'å¥‡ç¾åšç‰©é¤¨', lat: 23.0006, lng: 120.2344, icon: 'ğŸ›ï¸', typeName: 'åšç‰©é¤¨', desc: 'æ­å¼å®®æ®¿åšç‰©é¤¨' },
            { name: 'åé¼“ä»ç³–æ–‡å‰µåœ’å€', lat: 22.9519, lng: 120.2458, icon: 'ğŸ¥', typeName: 'æ–‡å‰µåœ’å€', desc: 'é¼“æ¨‚èˆ‡ç³–å» ' },
            { name: 'å°å—å­”å»Ÿ', lat: 22.9904, lng: 120.2073, icon: 'ğŸ›ï¸', typeName: 'æ­·å²å¤è¹Ÿ', desc: 'å…¨å°é¦–å­¸' },
            { name: 'èŠ±åœ’å¤œå¸‚', lat: 23.0156, lng: 120.1839, icon: 'ğŸŒƒ', typeName: 'å¤œå¸‚', desc: 'å°å—æœ€å¤§å¤œå¸‚' },
            { name: 'é»ƒé‡‘æµ·å²¸', lat: 23.0403, lng: 120.1147, icon: 'ğŸ–ï¸', typeName: 'æµ·ç˜', desc: 'çœ‹å¤•é™½æˆ²æ°´' },
            { name: 'è™é ­åŸ¤é¢¨æ™¯å€', lat: 23.0578, lng: 120.3292, icon: 'ğŸï¸', typeName: 'é¢¨æ™¯å€', desc: 'æ¹–å…‰å±±è‰²' },
            { name: 'çƒå±±é ­æ°´åº«', lat: 23.2050, lng: 120.3506, icon: 'ğŸï¸', typeName: 'æ°´åº«æ™¯é»', desc: 'çŠç‘šæ½­ç¾æ™¯' },
            { name: 'å·¦é®åŒ–çŸ³åœ’å€', lat: 23.0614, lng: 120.4069, icon: 'ğŸ¦´', typeName: 'åšç‰©é¤¨', desc: 'åŒ–çŸ³èˆ‡è€ƒå¤' }
        ];

        // Predefined recommended attractions for each route (for initial load)
        const RECOMMENDED_ATTRACTIONS = {
            route2: [
                { name: 'æ±çŸ³æ¼äººç¢¼é ­', lat: 23.4603, lng: 120.1492, icon: 'âš“', typeName: 'è§€å…‰æ¼æ¸¯', desc: 'å¤•é™½ç¾æ™¯èˆ‡æµ·é®®' },
                { name: 'æœ´å­é…å¤©å®®', lat: 23.4647, lng: 120.2475, icon: 'â›©ï¸', typeName: 'å»Ÿå®‡', desc: 'å˜‰ç¾©çŸ¥ååª½ç¥–å»Ÿ' },
                { name: 'è’œé ­ç³–å» ', lat: 23.4836, lng: 120.3119, icon: 'ğŸ­', typeName: 'æ–‡åŒ–åœ’å€', desc: 'æ­·å²ç³–å» èˆ‡äº”åˆ†è»Š' },
                { name: 'æ¿é™¶çª¯äº¤è¶¾å‰ªé»å·¥è—åœ’å€', lat: 23.5442, lng: 120.3647, icon: 'ğŸ¨', typeName: 'å·¥è—åœ’å€', desc: 'å‚³çµ±å·¥è—é«”é©—' },
                { name: 'åŒ—æ¸¯æœå¤©å®®', lat: 23.5719, lng: 120.3006, icon: 'â›©ï¸', typeName: 'å»Ÿå®‡', desc: 'å°ç£åª½ç¥–ä¿¡ä»°ä¸­å¿ƒ' },
                { name: 'æºªå£è€è¡—', lat: 23.6039, lng: 120.3933, icon: 'ğŸ®', typeName: 'è€è¡—', desc: 'å‚³çµ±è€è¡—é¢¨æƒ…' }
            ],
            day1: [
                { name: 'äº•ä»”è…³ç“¦ç›¤é¹½ç”°', lat: 23.1808, lng: 120.0769, icon: 'ğŸŒ…', typeName: 'é¹½ç”°æ™¯é»', desc: 'å°ç£æœ€å¤è€é¹½ç”°' },
                { name: 'åŒ—é–€æ°´æ™¶æ•™å ‚', lat: 23.2672, lng: 120.1231, icon: 'â›ª', typeName: 'åœ°æ¨™å»ºç¯‰', desc: 'IGç†±é–€æ‰“å¡é»' },
                { name: 'ä¸ƒè‚¡é¹½å±±', lat: 23.1408, lng: 120.1086, icon: 'â›°ï¸', typeName: 'è§€å…‰é¹½å±±', desc: 'å£¯è§€çš„ç™½è‰²é¹½å±±' },
                { name: 'å®‰å¹³å¤å ¡', lat: 22.9998, lng: 120.1606, icon: 'ğŸ°', typeName: 'æ­·å²å¤è¹Ÿ', desc: 'å°ç£æœ€å¤è€åŸå ¡' },
                { name: 'èµ¤å´æ¨“', lat: 22.9973, lng: 120.2025, icon: 'ğŸ›ï¸', typeName: 'æ­·å²å¤è¹Ÿ', desc: 'å°å—ä»£è¡¨æ€§å¤è¹Ÿ' },
                { name: 'ç¥è¾²è¡—', lat: 22.9978, lng: 120.1947, icon: 'ğŸ®', typeName: 'æ–‡å‰µè€è¡—', desc: 'æ–‡é’å¿…è¨ªè€è¡—' },
                { name: 'è—æ™’åœ–æ–‡å‰µåœ’å€', lat: 22.9908, lng: 120.2050, icon: 'ğŸ¨', typeName: 'æ–‡å‰µåœ’å€', desc: 'å‰µæ„è—è¡“ç©ºé–“' },
                { name: 'æ—ç™¾è²¨', lat: 22.9917, lng: 120.2025, icon: 'ğŸ¬', typeName: 'æ–‡å‰µç™¾è²¨', desc: 'å°å—éŠ€åº§æ‘©å¤©æ¨“' }
            ]
        };

        // Handle map move or zoom events (with debounce)
        function onMapMoveOrZoom() {
            if (loadNearbyTimeout) {
                clearTimeout(loadNearbyTimeout);
            }
            loadNearbyTimeout = setTimeout(() => {
                loadNearbyAttractionsFromMap();
            }, 500); // Wait 500ms after user stops moving
        }

        // Load nearby attractions based on current map view
        function loadNearbyAttractionsFromMap() {
            if (!map) return;

            const center = map.getCenter();
            const zoom = map.getZoom();

            // Calculate radius based on zoom level
            // Higher zoom = smaller area, lower zoom = larger area
            let radiusKm;
            if (zoom >= 13) {
                radiusKm = 5;
            } else if (zoom >= 11) {
                radiusKm = 15;
            } else if (zoom >= 9) {
                radiusKm = 30;
            } else {
                radiusKm = 50;
            }

            console.log('Loading attractions at', center.lat, center.lng, 'radius:', radiusKm, 'km, zoom:', zoom);

            loadNearbyAttractions(center.lat, center.lng, radiusKm, false);
        }

        // Load nearby attractions using Overpass API
        async function loadNearbyAttractions(centerLat = null, centerLng = null, radiusKm = 10, updateGrid = true) {
            const grid = document.getElementById('nearbyGrid');
            if (updateGrid) {
                grid.innerHTML = '<div class="loading-nearby">è¼‰å…¥é™„è¿‘æ™¯é»ä¸­...</div>';
            }

            console.log('Loading nearby attractions for route:', currentRoute);

            try {
                const route = ROUTES[currentRoute];
                const allLocations = [...route.locations, ...customLocations];

                // Use provided center or calculate from route
                if (centerLat === null || centerLng === null) {
                    centerLat = 0;
                    centerLng = 0;
                    allLocations.forEach(loc => {
                        centerLat += loc.lat;
                        centerLng += loc.lng;
                    });
                    centerLat /= allLocations.length;
                    centerLng /= allLocations.length;
                }

                console.log('Search center:', centerLat, centerLng, 'radius:', radiusKm, 'km');

                // Use all attractions database and filter by distance
                let attractions = ALL_ATTRACTIONS
                    .map(attr => ({
                        ...attr,
                        distance: calculateDistance(centerLat, centerLng, attr.lat, attr.lng)
                    }))
                    .filter(attr => {
                        // Filter by radius
                        if (attr.distance > radiusKm) return false;

                        // Filter out attractions already in route
                        return !allLocations.some(loc =>
                            Math.abs(loc.lat - attr.lat) < 0.01 &&
                            Math.abs(loc.lng - attr.lng) < 0.01
                        );
                    })
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 20); // Show up to 20 nearby attractions

                console.log('Filtered attractions:', attractions.length);

                // Display attractions
                if (attractions.length === 0) {
                    if (updateGrid) {
                        grid.innerHTML = '<div class="loading-nearby">æ‰¾ä¸åˆ°æ–°çš„æ™¯é»æ¨è–¦</div>';
                    }
                    nearbyAttractions = [];
                    showNearbyMarkersOnMap();
                    return;
                }

                displayAttractions(attractions, grid, updateGrid);

            } catch (error) {
                console.error('Error loading nearby attractions:', error);
                grid.innerHTML = '<div class="loading-nearby" style="color: #ef4444;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }

        // Display attractions in grid
        function displayAttractions(attractions, grid, updateGrid = true) {
            // Store attractions for map markers
            nearbyAttractions = attractions;

            console.log('Displaying', attractions.length, 'attractions');

            // Update grid UI only if requested
            if (updateGrid) {
                let html = '';
                attractions.forEach((attr, index) => {
                    html += `
                        <div class="nearby-card" onclick='addNearbyAttractionFromMap(${index})'>
                            <div class="nearby-card-header">
                                <span class="nearby-card-icon">${attr.icon}</span>
                                <span class="nearby-card-name">${attr.name}</span>
                            </div>
                            <div class="nearby-card-type">${attr.typeName}</div>
                            <div class="nearby-card-distance">ğŸ“ è·é›¢ç´„ ${attr.distance.toFixed(1)} å…¬é‡Œ</div>
                            <button class="nearby-card-add" onclick="event.stopPropagation(); addNearbyAttractionFromMap(${index})">
                                â• åŠ å…¥è¡Œç¨‹
                            </button>
                        </div>
                    `;
                });

                grid.innerHTML = html;
            }

            // Always update map markers
            if (map) {
                showNearbyMarkersOnMap();
            }
        }



        // Initialize
        function init() {
            console.log('Initializing...');

            try {
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet not loaded');
                }
                console.log('âœ“ Leaflet loaded');

                // Create map
                const route = ROUTES[currentRoute];
                const center = route.locations[0];

                map = L.map('map').setView([center.lat, center.lng], 9);
                console.log('âœ“ Map created');

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 18
                }).addTo(map);
                console.log('âœ“ Tiles added');

                // Show map container
                document.getElementById('mapContainer').style.display = 'block';
                document.getElementById('nearbyContainer').style.display = 'block';
                document.getElementById('searchContainer').style.display = 'block';
                document.getElementById('exportContainer').style.display = 'block';
                document.getElementById('status').style.display = 'none';

                // Force map to recalculate size
                setTimeout(() => {
                    map.invalidateSize();
                    console.log('âœ“ Map size invalidated');
                }, 100);

                // Show route
                showRoute(route);

                // Load nearby attractions
                loadNearbyAttractions();

                // Add map event listeners for dynamic loading
                map.on('moveend', onMapMoveOrZoom);
                map.on('zoomend', onMapMoveOrZoom);

                console.log('âœ“ Initialization complete');

            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('status').innerHTML =
                    '<div class="error">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // Show route
        function showRoute(route) {
            console.log('Showing route:', route.name);

            // Clear old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (polyline) map.removeLayer(polyline);

            const latlngs = [];
            const allLocations = [...route.locations, ...customLocations];

            // Add markers for route locations
            allLocations.forEach((loc, i) => {
                const isCustom = loc.custom || false;
                const markerColor = isCustom ? '#f59e0b' : route.color;
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="
                        background: ${markerColor};
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        border: 4px solid white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 18px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    ">${i + 1}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon }).addTo(map);

                const deleteButton = isCustom ?
                    `<button onclick="removeCustomLocation(${i - route.locations.length})" style="
                        margin-top: 8px;
                        padding: 6px 12px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 12px;
                    ">ğŸ—‘ï¸ ç§»é™¤æ­¤æ™¯é»</button>` : '';

                marker.bindPopup(`
                    <div style="padding: 10px;">
                        <h3 style="margin-bottom: 8px; font-size: 18px;">
                            ${loc.icon} ${loc.name}
                        </h3>
                        <p style="margin-bottom: 8px; color: #666;">${loc.desc}</p>
                        <p style="color: ${markerColor}; font-weight: bold;">â° ${loc.time}</p>
                        ${deleteButton}
                    </div>
                `);

                markers.push(marker);
                latlngs.push([loc.lat, loc.lng]);
            });

            // Add polyline
            polyline = L.polyline(latlngs, {
                color: route.color,
                weight: 5,
                opacity: 0.7
            }).addTo(map);

            // Show nearby attraction markers on map
            showNearbyMarkersOnMap();

            // Fit bounds - adjust padding based on screen size
            const isMobile = window.innerWidth < 768;
            const padding = isMobile ? [30, 30] : [80, 80];
            map.fitBounds(L.latLngBounds(latlngs), {
                padding: padding,
                maxZoom: 12
            });

            // Update location cards
            updateLocationCards(route);

            // Update distance info
            updateDistanceInfo(route);
        }

        // Show nearby attraction markers on map (blue markers)
        function showNearbyMarkersOnMap() {
            // Clear old nearby markers
            nearbyMarkers.forEach(m => map.removeLayer(m));
            nearbyMarkers = [];

            // Add blue markers for nearby attractions
            nearbyAttractions.forEach((attr, i) => {
                const icon = L.divIcon({
                    className: 'nearby-marker-icon',
                    html: `<div style="
                        background: #3b82f6;
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        border: 3px solid white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 16px;
                        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
                        cursor: pointer;
                    ">${attr.icon}</div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 17.5]
                });

                const marker = L.marker([attr.lat, attr.lng], { icon }).addTo(map);

                marker.bindPopup(`
                    <div style="padding: 10px; min-width: 200px;">
                        <div style="background: #eff6ff; padding: 8px; border-radius: 8px; margin-bottom: 10px;">
                            <span style="color: #3b82f6; font-weight: bold; font-size: 12px;">âœ¨ æ¨è–¦æ™¯é»</span>
                        </div>
                        <h3 style="margin-bottom: 8px; font-size: 18px;">
                            ${attr.icon} ${attr.name}
                        </h3>
                        <p style="margin-bottom: 8px; color: #666; font-size: 13px;">
                            <strong>${attr.typeName}</strong>
                        </p>
                        <p style="color: #10b981; font-weight: bold; font-size: 13px; margin-bottom: 12px;">
                            ğŸ“ è·é›¢ç´„ ${attr.distance.toFixed(1)} å…¬é‡Œ
                        </p>
                        <button onclick="addNearbyAttractionFromMap(${i})" style="
                            width: 100%;
                            padding: 10px 16px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 14px;
                        ">â• åŠ å…¥è¡Œç¨‹</button>
                    </div>
                `);

                nearbyMarkers.push(marker);
            });
        }

        // Add nearby attraction from map marker
        function addNearbyAttractionFromMap(index) {
            const attr = nearbyAttractions[index];
            if (!attr) return;

            const newLocation = {
                name: attr.name,
                desc: attr.typeName,
                lat: attr.lat,
                lng: attr.lng,
                icon: attr.icon,
                time: 'è‡ªè¨‚',
                custom: true
            };

            customLocations.push(newLocation);

            // Update map and info
            const route = ROUTES[currentRoute];
            showRoute(route);

            // Reload nearby attractions to refresh the list
            loadNearbyAttractions();

            // Close popup
            map.closePopup();

            console.log('Added nearby attraction from map:', newLocation);
        }

        // Update location cards
        function updateLocationCards(route) {
            const container = document.getElementById('locationsList');
            const allLocations = [...route.locations, ...customLocations];

            let html = '';
            allLocations.forEach((loc, i) => {
                const isCustom = loc.custom || false;
                const markerColor = isCustom ? '#f59e0b' : route.color;
                const deleteButton = isCustom ?
                    `<button class="remove-btn" onclick="removeCustomLocation(${i - route.locations.length})">ğŸ—‘ï¸ ç§»é™¤</button>` : '';

                html += `
                    <div class="info-card ${isCustom ? 'custom-location' : ''}">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="location-icon">${loc.icon}</span>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="
                                        background: ${markerColor};
                                        color: white;
                                        padding: 4px 10px;
                                        border-radius: 12px;
                                        font-size: 14px;
                                        font-weight: bold;
                                    ">${i + 1}</span>
                                    <span class="location-name">${loc.name}</span>
                                    ${isCustom ? '<span style="background: #fbbf24; color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px;">è‡ªè¨‚</span>' : ''}
                                </div>
                                <div class="location-desc">${loc.desc}</div>
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                                    <div class="location-time">â° ${loc.time}</div>
                                    ${deleteButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Switch route
        function switchRoute(routeKey) {
            console.log('Switching to:', routeKey);
            currentRoute = routeKey;

            // Clear custom locations when switching routes
            customLocations = [];

            // Update buttons
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (routeKey === 'route2') {
                document.querySelector('.route2-btn').classList.add('active');
            } else {
                document.querySelector('.day1-btn').classList.add('active');
            }

            // Show route
            if (map) {
                showRoute(ROUTES[routeKey]);
                // Reload nearby attractions for the new route
                loadNearbyAttractions();
            }
        }

        // iOS Safari fallback for file download
        function iosDownloadFallback(blob, filename) {
            // Convert blob to base64 data URL
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;

                // Create a temporary link and try to trigger download
                const a = document.createElement('a');
                a.href = base64data;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);

                try {
                    a.click();
                    alert('ğŸ“± iPhone/iPad æª”æ¡ˆä¸‹è¼‰\n\nå¦‚æœæª”æ¡ˆæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹ï¼š\n\n1. é•·æŒ‰ä¸‹æ–¹çš„é€£çµ\n2. é¸æ“‡ã€Œä¸‹è¼‰é€£çµçš„æª”æ¡ˆã€\n3. æª”æ¡ˆæœƒå„²å­˜åˆ°ã€Œæª”æ¡ˆã€App çš„ä¸‹è¼‰è³‡æ–™å¤¾\n\næˆ–å˜—è©¦ä½¿ç”¨ Safari ä»¥å¤–çš„ç€è¦½å™¨ï¼ˆChromeã€Edgeï¼‰');
                } catch (e) {
                    console.error('iOS download failed:', e);
                    alert('âŒ ä¸‹è¼‰å¤±æ•—\n\niPhone Safari å¯èƒ½ä¸æ”¯æ´æ­¤ä¸‹è¼‰æ–¹å¼ã€‚\n\nå»ºè­°ï¼š\n1. ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨\n2. æˆ–ä½¿ç”¨é›»è…¦ä¸‹è¼‰\n3. æˆ–è«‹å…¶ä»–äººç”¨ Android æ‰‹æ©Ÿä¸‹è¼‰å¾Œå‚³çµ¦æ‚¨');
                }

                document.body.removeChild(a);
            };
            reader.readAsDataURL(blob);
        }

        // Export to Word document
        function exportToWord() {
            try {
                // Check if required libraries are loaded
                if (typeof htmlDocx === 'undefined') {
                    alert('âŒ Word åŒ¯å‡ºåŠŸèƒ½è¼‰å…¥å¤±æ•—\n\nç„¡æ³•è¼‰å…¥ html-docx-js å‡½å¼åº«ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. é˜²ç«ç‰†æˆ–å»£å‘Šå°é–ç¨‹å¼é˜»æ“‹\n3. ç€è¦½å™¨å®‰å…¨è¨­å®š\n\nè«‹å˜—è©¦ï¼š\nâ€¢ é‡æ–°æ•´ç†é é¢ (F5)\nâ€¢ æš«æ™‚é—œé–‰å»£å‘Šå°é–ç¨‹å¼\nâ€¢ ä½¿ç”¨å…¶ä»–ç€è¦½å™¨\nâ€¢ æª¢æŸ¥ç¶²è·¯é€£ç·š');
                    console.error('html-docx-js library not loaded');
                    return;
                }

                // FileSaver is only required for desktop browsers
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (!isMobile && typeof saveAs === 'undefined') {
                    alert('âŒ æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½è¼‰å…¥å¤±æ•—\n\nç„¡æ³•è¼‰å…¥ FileSaver å‡½å¼åº«ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. é˜²ç«ç‰†æˆ–å»£å‘Šå°é–ç¨‹å¼é˜»æ“‹\n3. ç€è¦½å™¨å®‰å…¨è¨­å®š\n\nè«‹å˜—è©¦ï¼š\nâ€¢ é‡æ–°æ•´ç†é é¢ (F5)\nâ€¢ æš«æ™‚é—œé–‰å»£å‘Šå°é–ç¨‹å¼\nâ€¢ ä½¿ç”¨å…¶ä»–ç€è¦½å™¨\nâ€¢ æª¢æŸ¥ç¶²è·¯é€£ç·š');
                    console.error('FileSaver library not loaded');
                    return;
                }

                const route = ROUTES[currentRoute];
                const allLocations = [...route.locations, ...customLocations];

                // Calculate total distance and time
                let totalDistance = 0;
                let totalMinutes = 0;
                for (let i = 0; i < allLocations.length - 1; i++) {
                    const distance = calculateDistance(
                        allLocations[i].lat, allLocations[i].lng,
                        allLocations[i + 1].lat, allLocations[i + 1].lng
                    );
                    totalDistance += distance;
                    totalMinutes += Math.round(distance / 50 * 60);
                }

                const today = new Date();
                const dateStr = today.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Create HTML content
                let htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${route.name} - è¡Œç¨‹è¦åŠƒå ±å‘Š</title>
    <style>
        body {
            font-family: "Microsoft YaHei", "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        h2 {
            color: #667eea;
            font-size: 22px;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 20px;
            margin-bottom: 5px;
        }
        .date {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary p {
            margin: 10px 0;
            font-size: 16px;
        }
        .summary strong {
            color: #667eea;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 10px 12px;
            border: 1px solid #ddd;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .custom-location {
            background: #fff3cd !important;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }
        li:before {
            content: "â€¢";
            color: #667eea;
            font-weight: bold;
            position: absolute;
            left: 5px;
        }
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #999;
            font-size: 14px;
        }
        .footer .wish {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ºï¸ å°ç£æ—…éŠè¡Œç¨‹è¦åŠƒå ±å‘Š</h1>
    <div class="subtitle">${route.name}</div>
    <div class="date">è£½ä½œæ—¥æœŸï¼š${dateStr}</div>

    <h2>ğŸ“Š è¡Œç¨‹æ‘˜è¦</h2>
    <div class="summary">
        <p><strong>ç¸½æ™¯é»æ•¸ï¼š</strong>${allLocations.length} å€‹</p>
        <p><strong>ç¸½è·é›¢ï¼š</strong>${totalDistance.toFixed(1)} å…¬é‡Œ</p>
        <p><strong>é ä¼°è¡Œè»Šæ™‚é–“ï¼š</strong>${estimateTime(totalDistance)}</p>
    </div>

    <h2>ğŸ—“ï¸ è©³ç´°è¡Œç¨‹</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 8%;">é †åº</th>
                <th style="width: 25%;">æ™¯é»åç¨±</th>
                <th style="width: 37%;">æè¿°</th>
                <th style="width: 15%;">æ™‚é–“</th>
                <th style="width: 15%;">å‚™è¨»</th>
            </tr>
        </thead>
        <tbody>
`;

                // Add location rows
                allLocations.forEach((loc, i) => {
                    const note = loc.custom ? 'è‡ªè¨‚æ™¯é»' : 'æ¨è–¦æ™¯é»';
                    const rowClass = loc.custom ? 'custom-location' : '';
                    htmlContent += `
            <tr class="${rowClass}">
                <td style="text-align: center;">${i + 1}</td>
                <td>${loc.icon} ${loc.name}</td>
                <td>${loc.desc}</td>
                <td style="text-align: center;">${loc.time}</td>
                <td style="text-align: center;">${note}</td>
            </tr>
`;
                });

                htmlContent += `
        </tbody>
    </table>

    <h2>ğŸš— è·¯ç¨‹è³‡è¨Š</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 35%;">èµ·é»</th>
                <th style="width: 35%;">çµ‚é»</th>
                <th style="width: 15%;">è·é›¢</th>
                <th style="width: 15%;">é ä¼°æ™‚é–“</th>
            </tr>
        </thead>
        <tbody>
`;

                // Add distance rows
                for (let i = 0; i < allLocations.length - 1; i++) {
                    const start = allLocations[i];
                    const end = allLocations[i + 1];
                    const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);

                    htmlContent += `
            <tr>
                <td>${start.icon} ${start.name}</td>
                <td>${end.icon} ${end.name}</td>
                <td style="text-align: center;">${distance.toFixed(1)} å…¬é‡Œ</td>
                <td style="text-align: center;">${estimateTime(distance)}</td>
            </tr>
`;
                }

                htmlContent += `
        </tbody>
    </table>

    <h2>ğŸ’¡ æ—…éŠå»ºè­°</h2>
    <ul>
        <li>å»ºè­°æå‰é è¨‚ç†±é–€æ™¯é»é–€ç¥¨ï¼Œé¿å…ç¾å ´æ’éšŠç­‰å€™</li>
        <li>è¡Œè»Šæ™‚è«‹æ³¨æ„è·¯æ³ï¼Œå»ºè­°ä½¿ç”¨ Google Maps å°èˆª</li>
        <li>å„æ™¯é»åœç•™æ™‚é–“å¯ä¾å¯¦éš›æƒ…æ³å½ˆæ€§èª¿æ•´</li>
        <li>å»ºè­°æ”œå¸¶é˜²æ›¬ç”¨å“ã€é›¨å…·åŠå……è¶³é£²ç”¨æ°´</li>
        <li>å“åšåœ¨åœ°ç¾é£Ÿæ™‚ï¼Œæ³¨æ„ç‡Ÿæ¥­æ™‚é–“èˆ‡å…¬ä¼‘æ—¥</li>
        <li>éƒ¨åˆ†æ™¯é»å¯èƒ½éœ€è¦é–€ç¥¨ï¼Œå»ºè­°äº‹å…ˆæŸ¥è©¢</li>
        <li>å»ºè­°æ—©ä¸Šæ—©é»å‡ºç™¼ï¼Œé¿é–‹äº¤é€šå°–å³°æ™‚æ®µ</li>
    </ul>

    <div class="footer">
        <div class="wish">ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼ğŸŒŸ</div>
        <div>æœ¬å ±å‘Šç”±å°ç£æ—…éŠè·¯ç·šè¦åŠƒç³»çµ±è‡ªå‹•ç”Ÿæˆ</div>
    </div>
</body>
</html>
`;

                // Convert HTML to Word using html-docx-js
                const converted = htmlDocx.asBlob(htmlContent);
                const fileName = `${route.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')}_${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}.docx`;

                // Detect device type
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                // Download - use different methods based on device and browser
                if (isMobile && navigator.share && isIOS) {
                    // iOS Share API (best option for iPhone/iPad)
                    const file = new File([converted], fileName, { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });

                    navigator.share({
                        files: [file],
                        title: route.name,
                        text: 'å°ç£æ—…éŠè¡Œç¨‹è¦åŠƒå ±å‘Š'
                    }).then(() => {
                        console.log('File shared successfully');
                    }).catch((error) => {
                        console.error('Share failed:', error);
                        // Fallback for iOS if share fails
                        iosDownloadFallback(converted, fileName);
                    });
                } else if (isMobile) {
                    // Android and other mobile browsers
                    try {
                        const url = URL.createObjectURL(converted);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();

                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);

                        alert('ğŸ“± æª”æ¡ˆå·²æº–å‚™ä¸‹è¼‰\n\nè«‹æª¢æŸ¥æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾æˆ–ç€è¦½å™¨çš„ä¸‹è¼‰é€šçŸ¥ã€‚\n\næª”æ¡ˆåç¨±ï¼š' + fileName);
                    } catch (error) {
                        console.error('Mobile download failed:', error);
                        if (isIOS) {
                            iosDownloadFallback(converted, fileName);
                        } else {
                            throw error;
                        }
                    }
                } else {
                    // Desktop download using FileSaver
                    saveAs(converted, fileName);
                }

                console.log('Word document generated:', fileName);

            } catch (error) {
                console.error('Error generating Word document:', error);
                alert('ç”Ÿæˆå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // Allow Enter key to search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchLocation();
                    }
                });
            }
        });

        // Start when page loads
        function waitForLeaflet() {
            if (typeof L !== 'undefined') {
                console.log('Leaflet ready, initializing...');
                init();
            } else {
                console.log('Waiting for Leaflet...');
                setTimeout(waitForLeaflet, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForLeaflet);
        } else {
            waitForLeaflet();
        }
    </script>
</body>
</html>
