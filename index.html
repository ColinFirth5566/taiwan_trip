<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ å°ç£å˜‰ç¾©å°å—æ—…éŠè·¯ç·š</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .route-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .route-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .route-btn.active {
            transform: scale(1.05);
        }

        .route2-btn {
            background: #10b981;
            color: white;
        }

        .day1-btn {
            background: #f59e0b;
            color: white;
        }

        .map-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            min-height: 400px;
        }

        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #searchInput {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        #searchInput:focus {
            border-color: #667eea;
        }

        .search-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background: #5568d3;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .distance-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .distance-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .distance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .distance-table th,
        .distance-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .distance-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        .distance-total {
            font-weight: bold;
            background: #f0f9ff;
            color: #3b82f6;
        }

        .custom-location {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .remove-btn {
            padding: 4px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            #map {
                height: 400px;
            }

            .route-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .search-box {
                flex-direction: column;
            }

            .distance-table {
                font-size: 14px;
            }

            .distance-table th,
            .distance-table td {
                padding: 8px;
            }
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .info-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .location-icon {
            font-size: 40px;
            margin-right: 10px;
        }

        .location-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .location-desc {
            color: #666;
            font-size: 14px;
            margin: 8px 0;
        }

        .location-time {
            color: #3b82f6;
            font-weight: bold;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
            padding: 50px;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ å°ç£å˜‰ç¾©å°å—æ—…éŠè·¯ç·š</h1>

        <div class="route-buttons">
            <button class="route-btn route2-btn active" onclick="switchRoute('route2')">
                ğŸŒ¿ è·¯ç·šäºŒï¼šå˜‰ç¾©æ–‡åŒ–ä¹‹æ—…
            </button>
            <button class="route-btn day1-btn" onclick="switchRoute('day1')">
                ğŸœ ç¬¬ä¸€å¤©ï¼šå°å—ç¾é£Ÿä¹‹æ—…
            </button>
        </div>

        <div id="status" class="loading">è¼‰å…¥ä¸­...</div>

        <div class="search-container" id="searchContainer" style="display: none;">
            <h2 style="margin-bottom: 15px;">ğŸ” æœå°‹ä¸¦æ–°å¢æ™¯é»</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¼¸å…¥æ™¯é»åç¨±æˆ–åœ°å€ï¼ˆä¾‹å¦‚ï¼šé˜¿é‡Œå±±ã€å°å—å­”å»Ÿï¼‰">
                <button class="search-btn" onclick="searchLocation()">æœå°‹</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="map-container" id="mapContainer" style="display: none;">
            <h2 style="margin-bottom: 15px;">ğŸ“ äº’å‹•å¼åœ°åœ–</h2>
            <div id="map"></div>
        </div>

        <div class="distance-info" id="distanceInfo" style="display: none;">
            <h3>ğŸš— è·¯ç¨‹è³‡è¨Š</h3>
            <table class="distance-table">
                <thead>
                    <tr>
                        <th>èµ·é»</th>
                        <th>çµ‚é»</th>
                        <th>è·é›¢</th>
                        <th>é ä¼°æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="distanceTableBody"></tbody>
            </table>
        </div>

        <div id="locationsList" class="info-cards"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Control Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

    <script>
        console.log('=== Script Started ===');

        // Route data
        const ROUTES = {
            route2: {
                name: 'è·¯ç·šäºŒï¼šå˜‰ç¾©æ–‡åŒ–ä¹‹æ—…',
                color: '#10b981',
                locations: [
                    { name: 'æ•…å®®å—é™¢', desc: 'åœ‹ç«‹æ•…å®®åšç‰©é™¢å—éƒ¨é™¢å€', lat: 23.4694, lng: 120.3394, icon: 'ğŸ›ï¸', time: '09:00-11:00' },
                    { name: 'å¸ƒè¢‹æ¼æ¸¯', desc: 'æ–°é®®æµ·ç”¢ã€è§€å…‰æ¼æ¸¯', lat: 23.3778, lng: 120.1647, icon: 'âš“', time: '11:30-12:30' },
                    { name: 'è‹±ç¾©å¤§åˆ©ç”Ÿéºµ', desc: 'å¸ƒè¢‹åœ¨åœ°ç¾é£Ÿ', lat: 23.3765, lng: 120.1655, icon: 'ğŸ', time: '12:30-13:30' },
                    { name: 'é«˜è·Ÿé‹æ•™å ‚', desc: 'IGæ‰“å¡ç†±é»', lat: 23.3625, lng: 120.1394, icon: 'ğŸ‘ ', time: '14:00-15:00' },
                    { name: 'æ–°æ¸¯é¦™è—æ–‡åŒ–åœ’å€', desc: 'é¦™è—æ–‡åŒ–é«”é©—', lat: 23.5547, lng: 120.3478, icon: 'ğŸ•¯ï¸', time: '15:30-16:30' },
                    { name: 'æ–°æ¸¯è€è¡—', desc: 'å‚³çµ±è€è¡—å°åƒ', lat: 23.5569, lng: 120.3456, icon: 'ğŸ®', time: '17:00-18:30' }
                ]
            },
            day1: {
                name: 'ç¬¬ä¸€å¤©ï¼šå°å—ç¾é£Ÿä¹‹æ—…',
                color: '#f59e0b',
                locations: [
                    { name: 'å—é¯¤é¯“ä»£å¤©å®®', desc: 'å°ç£ç‹çˆºç¸½å»Ÿ', lat: 23.2861, lng: 120.0758, icon: 'â›©ï¸', time: '09:00-11:00' },
                    { name: 'é˜¿æ¨‚æ´»æµ·é®®', desc: 'æ–°é®®æµ·ç”¢æ–™ç†', lat: 23.1408, lng: 120.1472, icon: 'ğŸ¦', time: '12:00-13:30' },
                    { name: 'é£¯åº— Check-in', desc: 'ä¼‘æ¯æ”¾é¬†æ™‚å…‰', lat: 22.9908, lng: 120.2133, icon: 'ğŸ¨', time: '14:00-17:00' },
                    { name: 'åœ‹è¯è¡—å¤œå¸‚', desc: 'å°å—ç¾é£Ÿå¤©å ‚', lat: 22.9974, lng: 120.1973, icon: 'ğŸŒƒ', time: '18:00-21:00' }
                ]
            }
        };

        let currentRoute = 'route2';
        let map = null;
        let markers = [];
        let polyline = null;
        let customLocations = [];

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Estimate driving time (assuming average speed 50 km/h)
        function estimateTime(distance) {
            const hours = distance / 50;
            const minutes = Math.round(hours * 60);
            if (minutes < 60) {
                return minutes + ' åˆ†é˜';
            } else {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return h + ' å°æ™‚ ' + (m > 0 ? m + ' åˆ†é˜' : '');
            }
        }

        // Update distance information
        function updateDistanceInfo(route) {
            const locations = [...route.locations, ...customLocations];
            if (locations.length < 2) {
                document.getElementById('distanceInfo').style.display = 'none';
                return;
            }

            let html = '';
            let totalDistance = 0;
            let totalMinutes = 0;

            for (let i = 0; i < locations.length - 1; i++) {
                const start = locations[i];
                const end = locations[i + 1];
                const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
                const minutes = Math.round(distance / 50 * 60);

                totalDistance += distance;
                totalMinutes += minutes;

                html += `
                    <tr>
                        <td>${start.icon || 'ğŸ“'} ${start.name}</td>
                        <td>${end.icon || 'ğŸ“'} ${end.name}</td>
                        <td>${distance.toFixed(1)} å…¬é‡Œ</td>
                        <td>${estimateTime(distance)}</td>
                    </tr>
                `;
            }

            html += `
                <tr class="distance-total">
                    <td colspan="2">ç¸½è¨ˆ</td>
                    <td>${totalDistance.toFixed(1)} å…¬é‡Œ</td>
                    <td>${estimateTime(totalDistance)}</td>
                </tr>
            `;

            document.getElementById('distanceTableBody').innerHTML = html;
            document.getElementById('distanceInfo').style.display = 'block';
        }

        // Search location using Nominatim
        async function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div style="padding: 12px;">æœå°‹ä¸­...</div>';
            resultsDiv.classList.add('active');

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' å°ç£')}&limit=5`
                );
                const results = await response.json();

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 12px; color: #999;">æ‰¾ä¸åˆ°çµæœ</div>';
                    return;
                }

                let html = '';
                results.forEach((result, index) => {
                    html += `
                        <div class="search-result-item" onclick="addCustomLocation(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
                            <strong>ğŸ“ ${result.display_name.split(',')[0]}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ${result.display_name}
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div style="padding: 12px; color: red;">æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }

        // Add custom location to route
        function addCustomLocation(lat, lng, name) {
            const shortName = name.split(',')[0];
            const newLocation = {
                name: shortName,
                desc: name,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                icon: 'â­',
                time: 'è‡ªè¨‚',
                custom: true
            };

            customLocations.push(newLocation);

            // Hide search results
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchInput').value = '';

            // Update map and info
            const route = ROUTES[currentRoute];
            showRoute(route);

            console.log('Added custom location:', newLocation);
        }

        // Remove custom location
        function removeCustomLocation(index) {
            customLocations.splice(index, 1);
            const route = ROUTES[currentRoute];
            showRoute(route);
        }

        // Initialize
        function init() {
            console.log('Initializing...');

            try {
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet not loaded');
                }
                console.log('âœ“ Leaflet loaded');

                // Create map
                const route = ROUTES[currentRoute];
                const center = route.locations[0];

                map = L.map('map').setView([center.lat, center.lng], 9);
                console.log('âœ“ Map created');

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 18
                }).addTo(map);
                console.log('âœ“ Tiles added');

                // Show map container
                document.getElementById('mapContainer').style.display = 'block';
                document.getElementById('searchContainer').style.display = 'block';
                document.getElementById('status').style.display = 'none';

                // Force map to recalculate size
                setTimeout(() => {
                    map.invalidateSize();
                    console.log('âœ“ Map size invalidated');
                }, 100);

                // Show route
                showRoute(route);

                console.log('âœ“ Initialization complete');

            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('status').innerHTML =
                    '<div class="error">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // Show route
        function showRoute(route) {
            console.log('Showing route:', route.name);

            // Clear old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (polyline) map.removeLayer(polyline);

            const latlngs = [];
            const allLocations = [...route.locations, ...customLocations];

            // Add markers
            allLocations.forEach((loc, i) => {
                const isCustom = loc.custom || false;
                const markerColor = isCustom ? '#f59e0b' : route.color;
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="
                        background: ${markerColor};
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        border: 4px solid white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 18px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    ">${i + 1}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon }).addTo(map);

                const deleteButton = isCustom ?
                    `<button onclick="removeCustomLocation(${i - route.locations.length})" style="
                        margin-top: 8px;
                        padding: 6px 12px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 12px;
                    ">ğŸ—‘ï¸ ç§»é™¤æ­¤æ™¯é»</button>` : '';

                marker.bindPopup(`
                    <div style="padding: 10px;">
                        <h3 style="margin-bottom: 8px; font-size: 18px;">
                            ${loc.icon} ${loc.name}
                        </h3>
                        <p style="margin-bottom: 8px; color: #666;">${loc.desc}</p>
                        <p style="color: ${markerColor}; font-weight: bold;">â° ${loc.time}</p>
                        ${deleteButton}
                    </div>
                `);

                markers.push(marker);
                latlngs.push([loc.lat, loc.lng]);
            });

            // Add polyline
            polyline = L.polyline(latlngs, {
                color: route.color,
                weight: 5,
                opacity: 0.7
            }).addTo(map);

            // Fit bounds - adjust padding based on screen size
            const isMobile = window.innerWidth < 768;
            const padding = isMobile ? [30, 30] : [80, 80];
            map.fitBounds(L.latLngBounds(latlngs), {
                padding: padding,
                maxZoom: 12
            });

            // Update location cards
            updateLocationCards(route);

            // Update distance info
            updateDistanceInfo(route);
        }

        // Update location cards
        function updateLocationCards(route) {
            const container = document.getElementById('locationsList');
            const allLocations = [...route.locations, ...customLocations];

            let html = '';
            allLocations.forEach((loc, i) => {
                const isCustom = loc.custom || false;
                const markerColor = isCustom ? '#f59e0b' : route.color;
                const deleteButton = isCustom ?
                    `<button class="remove-btn" onclick="removeCustomLocation(${i - route.locations.length})">ğŸ—‘ï¸ ç§»é™¤</button>` : '';

                html += `
                    <div class="info-card ${isCustom ? 'custom-location' : ''}">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span class="location-icon">${loc.icon}</span>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="
                                        background: ${markerColor};
                                        color: white;
                                        padding: 4px 10px;
                                        border-radius: 12px;
                                        font-size: 14px;
                                        font-weight: bold;
                                    ">${i + 1}</span>
                                    <span class="location-name">${loc.name}</span>
                                    ${isCustom ? '<span style="background: #fbbf24; color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px;">è‡ªè¨‚</span>' : ''}
                                </div>
                                <div class="location-desc">${loc.desc}</div>
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                                    <div class="location-time">â° ${loc.time}</div>
                                    ${deleteButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Switch route
        function switchRoute(routeKey) {
            console.log('Switching to:', routeKey);
            currentRoute = routeKey;

            // Clear custom locations when switching routes
            customLocations = [];

            // Update buttons
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (routeKey === 'route2') {
                document.querySelector('.route2-btn').classList.add('active');
            } else {
                document.querySelector('.day1-btn').classList.add('active');
            }

            // Show route
            if (map) {
                showRoute(ROUTES[routeKey]);
            }
        }

        // Allow Enter key to search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchLocation();
                    }
                });
            }
        });

        // Start when page loads
        function waitForLeaflet() {
            if (typeof L !== 'undefined') {
                console.log('Leaflet ready, initializing...');
                init();
            } else {
                console.log('Waiting for Leaflet...');
                setTimeout(waitForLeaflet, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForLeaflet);
        } else {
            waitForLeaflet();
        }
    </script>
</body>
</html>
